// Generated by CoffeeScript 1.3.3
(function() {

  this.Contextually = (function() {

    Contextually.prototype.firebaseRef = 'https://contextually.firebaseio.com';

    Contextually.prototype.input = $('#new-message');

    Contextually.prototype.messages = $('#messages');

    Contextually.prototype.topics = $('#topics');

    function Contextually() {
      this.userId = window.location.hash.substr(1);
      this.chatId = 11111;
      this.f = new Firebase("" + this.firebaseRef + "/chats/" + this.chatId + "/");
      this.input.focus();
      this.addListeners();
    }

    Contextually.prototype.addListeners = function() {
      var _this = this;
      this.input.on('keypress', function(e) {
        if (e.which === 13) {
          _this.addMessage();
          return e.preventDefault();
        }
      });
      this.f.child('message_list').on('value', function(snapshot) {
        _this.messageList = snapshot.val();
        return _this.renderMessages(snapshot.val());
      });
      return this.f.child('topics').on('value', function(snapshot) {
        return _this.renderTopics(snapshot.val());
      });
    };

    Contextually.prototype.addMessage = function() {
      this.saveMessage(this.input.val());
      return this.input.val('');
    };

    Contextually.prototype.saveMessage = function(text) {
      return this.f.child('message_list').push({
        user_id: this.userId,
        text: text
      });
    };

    Contextually.prototype.renderMessages = function(list) {
      var key, message, _results;
      this.messages.empty();
      _results = [];
      for (key in list) {
        message = list[key];
        message.key = key;
        _results.push(this.renderMessage(message));
      }
      return _results;
    };

    Contextually.prototype.renderMessage = function(message) {
      var _this = this;
      this.messages.append("<li class='message' id='" + message.key + "'>" + message.user_id + ": " + message.text + "</li>");
      return $("#" + message.key).on('click', function(e) {
        return _this.saveTopic(message);
      });
    };

    Contextually.prototype.saveTopic = function(message) {
      return this.f.child('topics').push({
        key: message.key
      });
    };

    Contextually.prototype.renderTopics = function(topics) {
      var key, message, topic, _results;
      this.topics.empty();
      _results = [];
      for (key in topics) {
        topic = topics[key];
        message = this.messageList[topic.key];
        _results.push(this.topics.append("<li class='topic'>" + message.text + "</li>"));
      }
      return _results;
    };

    return Contextually;

  })();

  $('document').ready(function() {
    return new Contextually();
  });

}).call(this);
